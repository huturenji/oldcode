var BigInteger=require("jsbn").BigInteger,THREE=new BigInteger("3"),ECFieldElementFp=function(){function i(t,i){this.x=i,this.q=t}return i.prototype.equals=function(t){return t===this||this.q.equals(t.q)&&this.x.equals(t.x)},i.prototype.toBigInteger=function(){return this.x},i.prototype.negate=function(){return new i(this.q,this.x.negate().mod(this.q))},i.prototype.add=function(t){return new i(this.q,this.x.add(t.toBigInteger()).mod(this.q))},i.prototype.subtract=function(t){return new i(this.q,this.x.subtract(t.toBigInteger()).mod(this.q))},i.prototype.multiply=function(t){return new i(this.q,this.x.multiply(t.toBigInteger()).mod(this.q))},i.prototype.divide=function(t){return new i(this.q,this.x.multiply(t.toBigInteger().modInverse(this.q)).mod(this.q))},i.prototype.square=function(){return new i(this.q,this.x.square().mod(this.q))},i}(),ECPointFp=function(){function l(t,i,e,n){this.curve=t,this.x=i,this.y=e,this.z=null==n?BigInteger.ONE:n,this.zinv=null}return l.prototype.getX=function(){return null===this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))},l.prototype.getY=function(){return null===this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))},l.prototype.equals=function(t){return t===this||(this.isInfinity()?t.isInfinity():t.isInfinity()?this.isInfinity():!!t.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(t.z)).mod(this.curve.q).equals(BigInteger.ZERO)&&t.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(t.z)).mod(this.curve.q).equals(BigInteger.ZERO))},l.prototype.isInfinity=function(){return null===this.x&&null===this.y||this.z.equals(BigInteger.ZERO)&&!this.y.toBigInteger().equals(BigInteger.ZERO)},l.prototype.negate=function(){return new l(this.curve,this.x,this.y.negate(),this.z)},l.prototype.add=function(t){var i,e,n,r,s,u,o,h;return this.isInfinity()?t:t.isInfinity()?this:(e=this.x.toBigInteger(),n=this.y.toBigInteger(),r=this.z,u=t.x.toBigInteger(),h=t.y.toBigInteger(),t=t.z,i=this.curve.q,e=e.multiply(t).mod(i),u=u.multiply(r).mod(i),o=e.subtract(u),n=n.multiply(t).mod(i),h=h.multiply(r).mod(i),h=n.subtract(h),BigInteger.ZERO.equals(o)?BigInteger.ZERO.equals(h)?this.twice():this.curve.infinity:(u=e.add(u),r=r.multiply(t).mod(i),t=o.square().mod(i),s=o.multiply(t).mod(i),u=r.multiply(h.square()).subtract(u.multiply(t)).mod(i),o=o.multiply(u).mod(i),h=h.multiply(t.multiply(e).subtract(u)).subtract(n.multiply(s)).mod(i),t=s.multiply(r).mod(i),new l(this.curve,this.curve.fromBigInteger(o),this.curve.fromBigInteger(h),t)))},l.prototype.twice=function(){var t,i,e,n,r,s,u,o;return this.isInfinity()?this:this.y.toBigInteger().signum()?(o=this.x.toBigInteger(),e=this.y.toBigInteger(),n=this.z,t=this.curve.q,u=this.curve.a.toBigInteger(),u=o.square().multiply(THREE).add(u.multiply(n.square())).mod(t),i=e.shiftLeft(1).multiply(n).mod(t),o=(e=e.square().mod(t)).multiply(o).multiply(n).mod(t),n=i.square().mod(t),r=u.square().subtract(o.shiftLeft(3)).mod(t),s=i.multiply(r).mod(t),u=u.multiply(o.shiftLeft(2).subtract(r)).subtract(n.shiftLeft(1).multiply(e)).mod(t),o=i.multiply(n).mod(t),new l(this.curve,this.curve.fromBigInteger(s),this.curve.fromBigInteger(u),o)):this.curve.infinity},l.prototype.multiply=function(t){if(this.isInfinity())return this;if(!t.signum())return this.curve.infinity;for(var i=t.multiply(THREE),e=this.negate(),n=this,r=i.bitLength()-2;0<r;r--){var n=n.twice(),s=i.testBit(r);s!==t.testBit(r)&&(n=n.add(s?this:e))}return n},l}(),ECCurveFp=function(){function t(t,i,e){this.q=t,this.a=this.fromBigInteger(i),this.b=this.fromBigInteger(e),this.infinity=new ECPointFp(this,null,null)}return t.prototype.equals=function(t){return t===this||this.q.equals(t.q)&&this.a.equals(t.a)&&this.b.equals(t.b)},t.prototype.fromBigInteger=function(t){return new ECFieldElementFp(this.q,t)},t.prototype.decodePointHex=function(t){switch(parseInt(t.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:return null;case 4:case 6:case 7:var i=(t.length-2)/2,e=t.substr(2,i),i=t.substr(2+i,i);return new ECPointFp(this,this.fromBigInteger(new BigInteger(e,16)),this.fromBigInteger(new BigInteger(i,16)));default:return null}},t}();module.exports={ECPointFp:ECPointFp,ECCurveFp:ECCurveFp};