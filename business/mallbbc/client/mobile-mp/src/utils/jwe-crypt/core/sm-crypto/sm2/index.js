var BigInteger=require("jsbn").BigInteger,_a=require("./asn1"),encodeDer=_a.encodeDer,decodeDer=_a.decodeDer,SM3Digest=require("./sm3"),SM2Cipher=require("./sm2"),_=require("./utils"),_b=_.generateEcparam(),G=_b.G,curve=_b.curve,n=_b.n,C1C2C3=0;function doEncrypt(e,r,t){void 0===t&&(t=1);var n=new SM2Cipher,i=(e instanceof Array||e instanceof Buffer||e instanceof ArrayBuffer||e instanceof Uint8Array||(e=_.hexToArray(_.parseUtf8StringToHex(e))),(r=128<r.length?r.substr(r.length-128):r).substr(0,64)),o=r.substr(64),i=(r=n.createPoint(i,o),n.initEncipher(r)),o=(n.encryptBlock(e),_.arrayToHex(e)),r=new Array(32);return n.doFinal(r),r=_.arrayToHex(r),t===C1C2C3?i+o+r:i+r+o}function doDecrypt(e,r,t){void 0===t&&(t=1);var n=new SM2Cipher,i=(r=new BigInteger(r,16),e.substr(0,64)),o=e.substr(0+i.length,64),a=i.length+o.length,g=e.substr(a,64),d=e.substr(a+64),t=(t===C1C2C3&&(g=e.substr(e.length-64),d=e.substr(a,e.length-a-64)),_.hexToArray(d)),e=n.createPoint(i,o),a=(n.initDecipher(r,e),n.decryptBlock(t),new Array(32));return n.doFinal(a),_.arrayToHex(a)===g?new Uint8Array(t):""}function doSignature(e,r,t){var t=void 0===t?{}:t,i=t.pointPool,o=t.der,a=t.hash,g=t.publicKey,t=t.userId,e="string"==typeof e?_.parseUtf8StringToHex(e):_.parseArrayBufferToHex(e),d=(a&&(e=doSm3Hash(e,g||getPublicKeyFromPrivateKey(r),t)),new BigInteger(r,16)),u=new BigInteger(e,16),s=null,l=null,y=null;do{do{var c=void 0,s=(c=i&&i.length?i.pop():getPoint()).k,l=u.add(c.x1).mod(n)}while(l.equals(BigInteger.ZERO)||l.add(s).equals(n))}while((y=d.add(BigInteger.ONE).modInverse(n).multiply(s.subtract(l.multiply(d))).mod(n)).equals(BigInteger.ZERO));return o?encodeDer(l,y):_.leftPad(l.toString(16),64)+_.leftPad(y.toString(16),64)}function doVerifySignature(e,r,t,i){var o,i=void 0===i?{}:i,a=i.der,g=i.hash,i=i.userId,e="string"==typeof e?_.parseUtf8StringToHex(e):_.parseArrayBufferToHex(e),a=(g&&(e=doSm3Hash(e,t,i)),i=a?(o=(g=decodeDer(r)).r,g.s):(o=new BigInteger(r.substring(0,64),16),new BigInteger(r.substring(64),16)),curve.decodePointHex(t)),g=new BigInteger(e,16),r=o.add(i).mod(n);return!r.equals(BigInteger.ZERO)&&(t=G.multiply(i).add(a.multiply(r)),e=g.add(t.getX().toBigInteger()).mod(n),o.equals(e))}function doSm3Hash(e,r,t){void 0===t&&(t="1234567812345678");var n=new SM3Digest,r=(new SM3Digest).getZ(G,r.substr(2,128),t),t=_.hexToArray(_.arrayToHex(r).toString()),r=_.hexToArray(e),e=new Array(n.getDigestSize());return n.blockUpdate(t,0,t.length),n.blockUpdate(r,0,r.length),n.doFinal(e,0),_.arrayToHex(e).toString()}function getPublicKeyFromPrivateKey(e){e=G.multiply(new BigInteger(e,16));return"04"+_.leftPad(e.getX().toBigInteger().toString(16),64)+_.leftPad(e.getY().toBigInteger().toString(16),64)}function getPoint(){var e=_.generateKeyPairHex(),r=curve.decodePointHex(e.publicKey);return e.k=new BigInteger(e.privateKey,16),e.x1=r.getX().toBigInteger(),e}module.exports={generateKeyPairHex:_.generateKeyPairHex,doEncrypt:doEncrypt,doDecrypt:doDecrypt,doSignature:doSignature,doVerifySignature:doVerifySignature,getPoint:getPoint};