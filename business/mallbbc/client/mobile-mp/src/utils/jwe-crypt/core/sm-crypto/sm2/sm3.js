var BigInteger=require("jsbn").BigInteger,_=require("./utils"),copyArray=function(t,e,r,i,s){for(var n=0;n<s;n++)r[i+n]=t[e+n]},Int32={minValue:-2147483648,maxValue:2147483647,parse:function(t){if(t<this.minValue){for(var e=(s=Number(-t).toString(2)).substr(s.length-31,31),r="",i=0;i<e.length;i++)r+="0"===e.substr(i,1)?"1":"0";return parseInt(r,2)+1}if(t>this.maxValue){for(var s,e=(s=Number(t).toString(2)).substr(s.length-31,31),r="",i=0;i<e.length;i++)r+="0"===e.substr(i,1)?"1":"0";return-(parseInt(r,2)+1)}return t},parseByte:function(t){if(t<0){for(var e,r=(e=Number(-t).toString(2)).substr(e.length-8,8),i="",s=0;s<r.length;s++)i+="0"===r.substr(s,1)?"1":"0";return(parseInt(i,2)+1)%256}return 255<t?(e=Number(t).toString(2),parseInt(e.substr(e.length-8,8),2)):t}},SM3Digest=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.xBuf=[],this.xBufOff=0,this.byteCount=0,this.DIGEST_LENGTH=32,this.v0=[1937774191,1226093241,388252375,3666478592,2842636476,372324522,3817729613,2969243214],this.v0=[1937774191,1226093241,388252375,-628488704,-1452330820,372324522,-477237683,-1325724082],this.v=new Array(8),this.v_=new Array(8),this.X0=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.X=new Array(68),this.xOff=0,this.T_00_15=2043430169,this.T_16_63=2055708042,0<t.length?this.initDigest(t[0]):this.init()}return t.prototype.init=function(){this.xBuf=new Array(4),this.reset()},t.prototype.initDigest=function(t){this.xBuf=[].concat(t.xBuf),this.xBufOff=t.xBufOff,this.byteCount=t.byteCount,copyArray(t.X,0,this.X,0,t.X.length),this.xOff=t.xOff,copyArray(t.v,0,this.v,0,t.v.length)},t.prototype.getDigestSize=function(){return this.DIGEST_LENGTH},t.prototype.reset=function(){this.byteCount=0,this.xBufOff=0;for(var t=Object.keys(this.xBuf),e=0,r=t.length;e<r;e++)this.xBuf[t[e]]=null;copyArray(this.v0,0,this.v,0,this.v0.length),this.xOff=0,copyArray(this.X0,0,this.X,0,this.X0.length)},t.prototype.processBlock=function(){for(var t=this.X,e=new Array(64),r=16;r<68;r++)t[r]=this.p1(t[r-16]^t[r-9]^this.rotate(t[r-3],15))^this.rotate(t[r-13],7)^t[r-6];for(r=0;r<64;r++)e[r]=t[r]^t[r+4];var i,s,n,o,h,f=this.v,a=this.v_;for(copyArray(f,0,a,0,this.v0.length),r=0;r<16;r++)h=this.rotate(a[0],12),i=Int32.parse(Int32.parse(h+a[4])+this.rotate(this.T_00_15,r)),s=(i=this.rotate(i,7))^h,n=Int32.parse(Int32.parse(this.ff_00_15(a[0],a[1],a[2])+a[3])+s)+e[r],o=Int32.parse(Int32.parse(this.gg_00_15(a[4],a[5],a[6])+a[7])+i)+t[r],a[3]=a[2],a[2]=this.rotate(a[1],9),a[1]=a[0],a[0]=n,a[7]=a[6],a[6]=this.rotate(a[5],19),a[5]=a[4],a[4]=this.p0(o);for(r=16;r<64;r++)h=this.rotate(a[0],12),i=Int32.parse(Int32.parse(h+a[4])+this.rotate(this.T_16_63,r)),s=(i=this.rotate(i,7))^h,n=Int32.parse(Int32.parse(this.ff_16_63(a[0],a[1],a[2])+a[3])+s)+e[r],o=Int32.parse(Int32.parse(this.gg_16_63(a[4],a[5],a[6])+a[7])+i)+t[r],a[3]=a[2],a[2]=this.rotate(a[1],9),a[1]=a[0],a[0]=n,a[7]=a[6],a[6]=this.rotate(a[5],19),a[5]=a[4],a[4]=this.p0(o);for(r=0;r<8;r++)f[r]^=Int32.parse(a[r]);this.xOff=0,copyArray(this.X0,0,this.X,0,this.X0.length)},t.prototype.processWord=function(t,e){var r=t[e]<<24,r=(r=(r|=(255&t[++e])<<16)|(255&t[++e])<<8)|255&t[++e];this.X[this.xOff]=r,16==++this.xOff&&this.processBlock()},t.prototype.processLength=function(t){14<this.xOff&&this.processBlock(),this.X[14]=this.urShiftLong(t,32),this.X[15]=4294967295&t},t.prototype.intToBigEndian=function(t,e,r){e[r]=255&Int32.parseByte(this.urShift(t,24)),e[++r]=255&Int32.parseByte(this.urShift(t,16)),e[++r]=255&Int32.parseByte(this.urShift(t,8)),e[++r]=255&Int32.parseByte(t)},t.prototype.doFinal=function(t,e){this.finish();for(var r=0;r<8;r++)this.intToBigEndian(this.v[r],t,e+4*r);return this.reset(),this.DIGEST_LENGTH},t.prototype.update=function(t){this.xBuf[this.xBufOff++]=t,this.xBufOff===this.xBuf.length&&(this.processWord(this.xBuf,0),this.xBufOff=0),this.byteCount++},t.prototype.blockUpdate=function(t,e,r){for(;0!==this.xBufOff&&0<r;)this.update(t[e]),e++,r--;for(;r>this.xBuf.length;)this.processWord(t,e),e+=this.xBuf.length,r-=this.xBuf.length,this.byteCount+=this.xBuf.length;for(;0<r;)this.update(t[e]),e++,r--},t.prototype.finish=function(){var t=this.byteCount<<3;for(this.update(128);0!==this.xBufOff;)this.update(0);this.processLength(t),this.processBlock()},t.prototype.rotate=function(t,e){return t<<e|this.urShift(t,32-e)},t.prototype.p0=function(t){return t^this.rotate(t,9)^this.rotate(t,17)},t.prototype.p1=function(t){return t^this.rotate(t,15)^this.rotate(t,23)},t.prototype.ff_00_15=function(t,e,r){return t^e^r},t.prototype.ff_16_63=function(t,e,r){return t&e|t&r|e&r},t.prototype.gg_00_15=function(t,e,r){return t^e^r},t.prototype.gg_16_63=function(t,e,r){return t&e|~t&r},t.prototype.urShift=function(t,e){return(t=t>Int32.maxValue||t<Int32.minValue?Int32.parse(t):t)>>>e},t.prototype.urShiftLong=function(t,e){var r=new BigInteger;if(r.fromInt(t),0<=r.signum())f=r.shiftRight(e).intValue();else{var r=new BigInteger,i=(r.fromInt(2),~e),s="";if(i<0){for(var n=64+i,o=0;o<n;o++)s+="0";var i=new BigInteger,h=(i.fromInt(t>>e),new BigInteger("10"+s,2)),s=h.toRadix(10),f=h.add(i).toRadix(10)}else f=(t>>e)+(s=r.shiftLeft(~e).intValue())}return f},t.prototype.getZ=function(t,e,r){var i=0;if(r){if("string"!=typeof r)throw new Error("sm2: Type of userId Must be String! Receive Type: ".concat(typeof r));if(8192<=r.length)throw new Error("sm2: The Length of userId Must Less Than 8192! Length: ".concat(r.length));i=4*(r=_.parseUtf8StringToHex(r)).length}this.update(i>>8&255),this.update(255&i),r&&(i=_.hexToArray(r),this.blockUpdate(i,0,i.length));var r=_.hexToArray(_.leftPad(t.curve.a.toBigInteger().toRadix(16),64)),i=_.hexToArray(_.leftPad(t.curve.b.toBigInteger().toRadix(16),64)),s=_.hexToArray(_.leftPad(t.getX().toBigInteger().toRadix(16),64)),t=_.hexToArray(_.leftPad(t.getY().toBigInteger().toRadix(16),64)),n=_.hexToArray(e.substr(0,64)),e=_.hexToArray(e.substr(64,64)),r=(this.blockUpdate(r,0,r.length),this.blockUpdate(i,0,i.length),this.blockUpdate(s,0,s.length),this.blockUpdate(t,0,t.length),this.blockUpdate(n,0,n.length),this.blockUpdate(e,0,e.length),new Array(this.getDigestSize()));return this.doFinal(r,0),r},t}();module.exports=SM3Digest;