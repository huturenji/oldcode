"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,o,a,l){return new(a=a||Promise)(function(r,t){function n(e){try{u(l.next(e))}catch(e){t(e)}}function i(e){try{u(l.throw(e))}catch(e){t(e)}}function u(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(n,i)}u((l=l.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,i){var u,o,a,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},c={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function e(r){return function(e){var t=[r,e];if(u)throw new TypeError("Generator is already executing.");for(;l=c&&t[c=0]?0:l;)try{if(u=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,o=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(a=0<(a=l.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))l.label=t[1];else if(6===t[0]&&l.label<a[1])l.label=a[1],a=t;else{if(!(a&&l.label<a[2])){a[2]&&l.ops.pop(),l.trys.pop();continue}l.label=a[2],l.ops.push(t)}}t=i.call(n,l)}catch(e){t=[6,e],o=0}finally{u=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},buffer_utils_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ecdhAllowed=exports.publicJwkToEphemeralKey=exports.generateEpk=exports.ephemeralKeyToPublicJWK=exports.deriveKey=void 0,require("../../lib/buffer_utils")),webcrypto_1=__importStar(require("./webcrypto")),digest_1=__importDefault(require("./digest")),concatKdf=buffer_utils_1.concatKdf.bind(void 0,digest_1.default.bind(void 0,"sha256")),deriveKey=function(i,u,o,a,l,c){return void 0===l&&(l=new Uint8Array),void 0===c&&(c=new Uint8Array),__awaiter(void 0,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:if((0,webcrypto_1.ensureSecureContext)(),t=(0,buffer_utils_1.concat)((0,buffer_utils_1.lengthAndInput)(buffer_utils_1.encoder.encode(o)),(0,buffer_utils_1.lengthAndInput)(l),(0,buffer_utils_1.lengthAndInput)(c),(0,buffer_utils_1.uint32be)(a)),u.usages.includes("deriveBits"))return n=Uint8Array.bind,[4,webcrypto_1.default.subtle.deriveBits({name:"ECDH",public:i},u,Math.ceil(parseInt(u.algorithm.namedCurve.substr(-3),10)/8)<<3)];throw new TypeError('ECDH-ES private key "usages" must include "deriveBits"');case 1:return r=new(n.apply(Uint8Array,[void 0,e.sent()])),[2,concatKdf(r,a,t)]}})})},ephemeralKeyToPublicJWK=(exports.deriveKey=deriveKey,function(u){return __awaiter(this,void 0,void 0,function(){var t,r,n,i;return __generator(this,function(e){switch(e.label){case 0:return(0,webcrypto_1.ensureSecureContext)(),[4,webcrypto_1.default.subtle.exportKey("jwk",u)];case 1:return i=e.sent(),t=i.crv,r=i.kty,n=i.x,i=i.y,[2,{crv:t,kty:r,x:n,y:i}]}})})}),generateEpk=(exports.ephemeralKeyToPublicJWK=ephemeralKeyToPublicJWK,function(t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return(0,webcrypto_1.ensureSecureContext)(),[4,webcrypto_1.default.subtle.generateKey({name:"ECDH",namedCurve:t.algorithm.namedCurve},!0,["deriveBits"])];case 1:return[2,e.sent().privateKey]}})})}),publicJwkToEphemeralKey=(exports.generateEpk=generateEpk,function(t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){return(0,webcrypto_1.ensureSecureContext)(),[2,webcrypto_1.default.subtle.importKey("jwk",t,{name:"ECDH",namedCurve:t.crv},!0,[])]})})}),curves=(exports.publicJwkToEphemeralKey=publicJwkToEphemeralKey,["P-256","P-384","P-521"]),ecdhAllowed=function(e){return curves.includes(e.algorithm.namedCurve)};exports.ecdhAllowed=ecdhAllowed;