"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},long_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importDefault(require("./long"))),SM3_CHUNK=64,SM3_SIZE=32,SM3_BLOCKSIZE=64,SM3_SIZE_BIT_SIZE=5,SM3_IV32=new Uint32Array([1937774191,1226093241,388252375,3666478592,2842636476,372324522,3817729613,2969243214]),SM3_T=[2043430169,2055708042],ERROR_MSG_INPUT="Input must be an string, Buffer or Uint8Array";function uint8(t){return 255&t}function uint32(t){return 4294967295&t}function rotateLeft32(t,r){r&=31;return t<<r|t>>>32-r}function _p0(t){return t^rotateLeft32(t,9)^rotateLeft32(t,17)}function _p1(t){return t^rotateLeft32(t,15)^rotateLeft32(t,23)}function _ff(t,r,n){return t&r|t&n|r&n}function _gg(t,r,n){return t&r|~t&n}function normalizeInput(t){if(t instanceof Uint8Array)return t;throw new Error(ERROR_MSG_INPUT)}function toHex(t){return Array.prototype.map.call(t,function(t){return(t<16?"0":"")+t.toString(16)}).join("")}function fromHex(t){if("string"!=typeof t||t.length%2==1)throw new Error("Invalid hex string");for(var r=[],n=0;n<t.length;n+=2)r.push(parseInt(t.substr(n,2),16));return new Uint8Array(r)}function testSpeed(t,r,n){for(var e=(new Date).getTime(),o=new Uint8Array(r),i=0;i<r;i++)o[i]=i%256;var a=(new Date).getTime();console.log("Generated random input in "+(a-e)+"ms"),e=a;for(i=0;i<n;i++){var u=t(o),f=(new Date).getTime(),s=f-e,e=f;console.log("Hashed in "+s+"ms: "+u.substring(0,20)+"..."),console.log(Math.round(r/(1<<20)/(s/1e3)*100)/100+" MB PER SECOND")}}function copy(t,r,n){for(var e=r;e<t.length&&e-r<n.length;e++)t[e]=n[e-r];return e-r}var Digest=function(){function r(){this.h=new Uint32Array(8),this.x=new Uint8Array(SM3_CHUNK),this.nx=0,this.len=new long_1.default(0,0,!0)}return r.prototype.clone=function(){var t=new r;t.nx=this.nx,t.len=new long_1.default(this.len.low,this.len.high,!0),t.h=new Uint32Array(8),copy(t.h,0,this.h),t.x=new Uint8Array(SM3_CHUNK),copy(t.x,0,this.x)},r.prototype.size=function(){return SM3_SIZE},r.prototype.blockSize=function(){return SM3_BLOCKSIZE},r.prototype.reset=function(){for(var t=0;t<8;t++)this.h[t]=SM3_IV32[t];this.x.fill(0),this.nx=0,this.len=new long_1.default(0,0,!0)},r.prototype.block=function(t){for(var r=new Uint32Array(8),n=new Uint32Array(8),e=new Uint32Array(68),o=0;o<8;o++)r[o]=this.h[o];for(;t.length>=SM3_CHUNK;){for(o=0;o<4;o++){var i=4*o;e[o]=uint32(t[i]<<24|t[i+1]<<16|t[i+2]<<8|t[i+3])}for(o=0;o<8;o++)n[o]=r[o];for(o=0;o<12;o++){i=4*(o+4);e[o+4]=uint32(t[i]<<24|t[i+1]<<16|t[i+2]<<8|t[i+3]);var a=(s=rotateLeft32(rotateLeft32(n[0],12)+n[4]+rotateLeft32(SM3_T[0],o),7))^rotateLeft32(n[0],12),u=(n[0]^n[1]^n[2])+n[3]+a+(e[o]^e[o+4]),f=(n[4]^n[5]^n[6])+n[7]+s+e[o];n[3]=n[2],n[2]=rotateLeft32(n[1],9),n[1]=n[0],n[0]=u,n[7]=n[6],n[6]=rotateLeft32(n[5],19),n[5]=n[4],n[4]=_p0(f)}for(o=12;o<16;o++){e[o+4]=_p1(e[o-12]^e[o-5]^rotateLeft32(e[o+1],15))^rotateLeft32(e[o-9],7)^e[o-2];a=(s=rotateLeft32(rotateLeft32(n[0],12)+n[4]+rotateLeft32(SM3_T[0],o),7))^rotateLeft32(n[0],12),u=(n[0]^n[1]^n[2])+n[3]+a+(e[o]^e[o+4]),f=(n[4]^n[5]^n[6])+n[7]+s+e[o];n[3]=n[2],n[2]=rotateLeft32(n[1],9),n[1]=n[0],n[0]=u,n[7]=n[6],n[6]=rotateLeft32(n[5],19),n[5]=n[4],n[4]=_p0(f)}for(o=16;o<64;o++){e[o+4]=_p1(e[o-12]^e[o-5]^rotateLeft32(e[o+1],15))^rotateLeft32(e[o-9],7)^e[o-2];var s,a=(s=rotateLeft32(rotateLeft32(n[0],12)+n[4]+rotateLeft32(SM3_T[1],o),7))^rotateLeft32(n[0],12),u=_ff(n[0],n[1],n[2])+n[3]+a+(e[o]^e[o+4]),f=_gg(n[4],n[5],n[6])+n[7]+s+e[o];n[3]=n[2],n[2]=rotateLeft32(n[1],9),n[1]=n[0],n[0]=u,n[7]=n[6],n[6]=rotateLeft32(n[5],19),n[5]=n[4],n[4]=_p0(f)}for(o=0;o<8;o++)r[o]^=n[o];t=t.subarray(SM3_CHUNK)}for(o=0;o<8;o++)this.h[o]=r[o]},r.prototype.write=function(t){var r;t=normalizeInput(t),this.len=this.len.add(t.length),0<this.nx&&(r=copy(this.x,this.nx,t),this.nx+=r,this.nx===SM3_CHUNK&&(this.block(this.x),this.nx=0),t=t.subarray(r)),t.length>=SM3_CHUNK&&(r=t.length&~(SM3_CHUNK-1),this.block(t.subarray(0,r)),t=t.subarray(r)),0<t.length&&(this.nx=copy(this.x,0,t))},r.prototype.update=function(t){this.write(t)},r.prototype.checkSum=function(){var t=new long_1.default(this.len.low,this.len.high,!0),r=new Uint8Array(64),n=(r[0]=128,this.len.mod(64).getLowBits());if(n<56?this.write(r.subarray(0,56-n)):this.write(r.subarray(0,120-n)),t=t.shl(3),r.set(t.toBytesBE()),this.write(r.subarray(0,8)),0!==this.nx)throw new Error("d.nx != 0");for(var e=new Uint8Array(SM3_SIZE),o=0;o<8;o++)e[4*o]=uint8(this.h[o]>>24),e[4*o+1]=uint8(this.h[o]>>16),e[4*o+2]=uint8(this.h[o]>>8),e[4*o+3]=uint8(this.h[o]);return e},r.prototype.finalize=function(){return this.checkSum()},r}();function sm3New(){var t=new Digest;return t.reset(),t}function sm3Sum(t){var r=new Digest;return r.reset(),r.write(t),r.checkSum()}function sm3SumHex(t){return toHex(sm3Sum(t))}function kdf(t,r){t=normalizeInput(t);for(var n=r+SM3_SIZE-1>>>SM3_SIZE_BIT_SIZE,e=new Uint8Array(4),o=1,i=new Uint8Array(r+SM3_SIZE-1),a=sm3New(),u=0;u<n;u++){e[0]=uint8(o>>>24),e[1]=uint8(o>>>16),e[2]=uint8(o>>>8),e[3]=uint8(o),a.update(t),a.update(e);for(var f=a.finalize(),s=0;s<SM3_SIZE;s++)i[u*SM3_SIZE+s]=f[s];o++,a.reset()}for(u=0;u<r;u++)if(0!==i[u])return i.subarray(0,r)}function byte1ToInt1(t){var r=new Uint32Array(1);return r[0]=r[0]|255&t,r}function int1Tobyte4(t){var r=new Uint8Array(4);return r[0]=t>>24&255,r[1]=t>>16&255,r[2]=t>>8&255,r[3]=255&t,r}function memset(t,r){for(var n=0;n<t.length;n++)t[n]=r}function memcpy(t,r,n,e,o){for(var i=0;i<o;i++)t[r+i]=n[e+i]}function stringToUint8Array(t){var r=0,n=t.length;if(n%2!=0)return null;n/=2;for(var e=new Array,o=0;o<n;o++){var i=t.substr(r,2),i=parseInt(i,16);e.push(i),r+=2}return new Uint8Array(e)}function doSm3Uint8ArrayUseUint8(t){return stringToUint8Array(sm3SumHex(t))}function hmacSm3(t,r){for(var n=t.length,e=new Uint32Array(16),o=0;o<16;o++)e[o]=byte1ToInt1(r[o])[0];for(var i=new Uint32Array(32),o=0;o<16;o++)i[o]=909522486^e[o],i[o+16]=1549556828^e[o];for(var a=new Uint8Array(128),o=0;o<16;o++)for(var u=int1Tobyte4(i[o]),f=int1Tobyte4(i[o+16]),s=o<<2,h=o+16<<2,c=0;c<4;c++)a[s+c]=u[c],a[h+c]=f[c];var y=new Uint8Array(n+64),t=(memset(y,0),memcpy(y,0,a,0,64),memcpy(y,64,t,0,n),doSm3Uint8ArrayUseUint8(y)),n=new Uint8Array(96);return memcpy(n,0,a,64,64),memcpy(n,64,t,0,32),doSm3Uint8ArrayUseUint8(n)}module.exports={hmacSm3:hmacSm3};