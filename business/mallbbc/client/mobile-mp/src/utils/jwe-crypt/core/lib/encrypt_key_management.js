"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,n){void 0===n&&(n=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&("get"in a?r.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,n,a)}:function(e,r,t,n){e[n=void 0===n?t:n]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__awaiter=this&&this.__awaiter||function(e,u,o,c){return new(o=o||Promise)(function(t,r){function n(e){try{s(c.next(e))}catch(e){r(e)}}function a(e){try{s(c.throw(e))}catch(e){r(e)}}function s(e){var r;e.done?t(e.value):((r=e.value)instanceof o?r:new o(function(e){e(r)})).then(n,a)}s((c=c.apply(e,u||[])).next())})},__generator=this&&this.__generator||function(n,a){var s,u,o,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function e(t){return function(e){var r=[t,e];if(s)throw new TypeError("Generator is already executing.");for(;c=i&&r[i=0]?0:c;)try{if(s=1,u&&(o=2&r[0]?u.return:r[0]?u.throw||((o=u.return)&&o.call(u),0):u.next)&&!(o=o.call(u,r[1])).done)return o;switch(u=0,(r=o?[2&r[0],o.value]:r)[0]){case 0:case 1:o=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,u=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!(o=0<(o=c.trys).length&&o[o.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3]))c.label=r[1];else if(6===r[0]&&c.label<o[1])c.label=o[1],o=r;else{if(!(o&&c.label<o[2])){o[2]&&c.ops.pop(),c.trys.pop();continue}c.label=o[2],c.ops.push(r)}}r=a.call(n,c)}catch(e){r=[6,e],u=0}finally{s=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}}},__rest=this&&this.__rest||function(e,r){var t={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&r.indexOf(a)<0&&(t[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,a=Object.getOwnPropertySymbols(e);n<a.length;n++)r.indexOf(a[n])<0&&Object.prototype.propertyIsEnumerable.call(e,a[n])&&(t[a[n]]=e[a[n]]);return t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},cek_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importStar(require("../lib/cek"))),errors_1=require("../util/errors"),random_1=__importDefault(require("../runtime/browser/random")),aeskw_1=require("../runtime/browser/aeskw"),ECDH=__importStar(require("../runtime/browser/ecdhes")),pbes2kw_1=require("../runtime/browser/pbes2kw"),rsaes_1=require("../runtime/browser/rsaes"),aesgcmkw_1=require("../runtime/browser/aesgcmkw"),base64url_1=require("../runtime/browser/base64url"),generateCek=(0,cek_1.default)(random_1.default);function encryptKeyManagement(f,d,y,b,h){var w;return void 0===h&&(h={}),__awaiter(this,void 0,void 0,function(){var r,t,n,a,s,u,o,c,i,l,p,_;return __generator(this,function(e){switch(e.label){case 0:switch(f){case"SM2":return[3,1];case"dir":return[3,3];case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":return[3,4];case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return[3,10];case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":return[3,12];case"A128KW":case"A192KW":case"A256KW":return[3,14];case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":return[3,16]}return[3,18];case 1:for(n=b||generateCek(d),l=require("../sm-crypto/sm2"),a=[],s=0;s<n.length;s++)a.push(n[s]);return[4,l.doEncrypt(a,y)];case 2:return r=e.sent(),[3,19];case 3:return n=y,[3,19];case 4:if(ECDH.ecdhAllowed(y))return u=h.apu,o=h.apv,c=h.epk,c?[3,6]:[4,ECDH.generateEpk(y)];throw new errors_1.JOSENotSupported("ECDH-ES with the provided key is not allowed or not supported by your javascript runtime");case 5:c=e.sent(),e.label=6;case 6:return[4,ECDH.ephemeralKeyToPublicJWK(c)];case 7:return i=e.sent(),[4,ECDH.deriveKey(y,c,"ECDH-ES"===f?d:f,parseInt(f.substr(-5,3),10)||cek_1.bitLengths.get(d),u,o)];case 8:return(l=e.sent(),t={epk:i},u&&(t.apu=(0,base64url_1.encode)(u)),o&&(t.apv=(0,base64url_1.encode)(o)),"ECDH-ES"===f)?(n=l,[3,19]):(n=b||generateCek(d),p=f.substr(-6),[4,(0,aeskw_1.wrap)(p,l,n)]);case 9:return r=e.sent(),[3,19];case 10:return n=b||generateCek(d),[4,(0,rsaes_1.encrypt)(f,y,n)];case 11:return r=e.sent(),[3,19];case 12:return n=b||generateCek(d),p=h.p2c,_=h.p2s,[4,(0,pbes2kw_1.encrypt)(f,y,n,p,_)];case 13:return w=e.sent(),r=w.encryptedKey,t=__rest(w,["encryptedKey"]),[3,19];case 14:return n=b||generateCek(d),[4,(0,aeskw_1.wrap)(f,y,n)];case 15:return r=e.sent(),[3,19];case 16:return n=b||generateCek(d),_=h.iv,[4,(0,aesgcmkw_1.wrap)(f,y,n,_)];case 17:return w=e.sent(),r=w.encryptedKey,t=__rest(w,["encryptedKey"]),[3,19];case 18:throw new errors_1.JOSENotSupported('unsupported or invalid "alg" (JWE Algorithm) header value');case 19:return[2,{cek:n,encryptedKey:r,parameters:t}]}})})}exports.default=encryptKeyManagement;