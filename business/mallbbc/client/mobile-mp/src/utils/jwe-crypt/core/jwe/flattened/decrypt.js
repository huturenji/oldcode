"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,i=arguments.length;t<i;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,a,d,c){return new(d=d||Promise)(function(t,r){function i(e){try{o(c.next(e))}catch(e){r(e)}}function n(e){try{o(c.throw(e))}catch(e){r(e)}}function o(e){var r;e.done?t(e.value):((r=e.value)instanceof d?r:new d(function(e){e(r)})).then(i,n)}o((c=c.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(i,n){var o,a,d,c={label:0,sent:function(){if(1&d[0])throw d[1];return d[1]},trys:[],ops:[]},l={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(t){return function(e){var r=[t,e];if(o)throw new TypeError("Generator is already executing.");for(;c=l&&r[l=0]?0:c;)try{if(o=1,a&&(d=2&r[0]?a.return:r[0]?a.throw||((d=a.return)&&d.call(a),0):a.next)&&!(d=d.call(a,r[1])).done)return d;switch(a=0,(r=d?[2&r[0],d.value]:r)[0]){case 0:case 1:d=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,a=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!(d=0<(d=c.trys).length&&d[d.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!d||r[1]>d[0]&&r[1]<d[3]))c.label=r[1];else if(6===r[0]&&c.label<d[1])c.label=d[1],d=r;else{if(!(d&&c.label<d[2])){d[2]&&c.ops.pop(),c.trys.pop();continue}c.label=d[2],c.ops.push(r)}}r=n.call(i,c)}catch(e){r=[6,e],a=0}finally{o=d=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},errors_1=(Object.defineProperty(exports,"__esModule",{value:!0}),require("../../util/errors")),is_disjoint_1=__importDefault(require("../../lib/is_disjoint")),is_object_1=__importDefault(require("../../lib/is_object")),base64url_1=require("../../runtime/browser/base64url"),decrypt_1=__importDefault(require("../../runtime/browser/decrypt")),zlib_1=require("../../runtime/browser/zlib"),buffer_utils_1=require("../../lib/buffer_utils"),cek_1=__importDefault(require("../../lib/cek")),random_1=__importDefault(require("../../runtime/browser/random")),validate_crit_1=__importDefault(require("../../lib/validate_crit")),validate_algorithms_1=__importDefault(require("../../lib/validate_algorithms")),generateCek=(0,cek_1.default)(random_1.default),checkExtensions=validate_crit_1.default.bind(void 0,errors_1.JWEInvalid,new Map),checkAlgOption=validate_algorithms_1.default.bind(void 0,"keyManagementAlgorithms"),checkEncOption=validate_algorithms_1.default.bind(void 0,"contentEncryptionAlgorithms");function flattenedDecrypt(l,s,u){return __awaiter(this,void 0,void 0,function(){var r,t,i,n,o,a,d,c;return __generator(this,function(e){switch(e.label){case 0:if(!(0,is_object_1.default)(l))throw new errors_1.JWEInvalid("Flattened JWE must be an object");if(void 0===l.protected&&void 0===l.header&&void 0===l.unprotected)throw new errors_1.JWEInvalid("JOSE Header missing");if("string"!=typeof l.iv)throw new errors_1.JWEInvalid("JWE Initialization Vector missing or incorrect type");if("string"!=typeof l.ciphertext)throw new errors_1.JWEInvalid("JWE Ciphertext missing or incorrect type");if("string"!=typeof l.tag)throw new errors_1.JWEInvalid("JWE Authentication Tag missing or incorrect type");if(void 0!==l.protected&&"string"!=typeof l.protected)throw new errors_1.JWEInvalid("JWE Protected Header incorrect type");if(void 0!==l.encrypted_key&&"string"!=typeof l.encrypted_key)throw new errors_1.JWEInvalid("JWE Encrypted Key incorrect type");if(void 0!==l.aad&&"string"!=typeof l.aad)throw new errors_1.JWEInvalid("JWE AAD incorrect type");if(void 0!==l.header&&!(0,is_object_1.default)(l.header))throw new errors_1.JWEInvalid("JWE Shared Unprotected Header incorrect type");if(void 0!==l.unprotected&&!(0,is_object_1.default)(l.unprotected))throw new errors_1.JWEInvalid("JWE Per-Recipient Unprotected Header incorrect type");if(l.protected&&(r=(0,base64url_1.decode)(l.protected),r=JSON.parse(buffer_utils_1.decoder.decode(r))),!(0,is_disjoint_1.default)(r,l.header,l.unprotected))throw new errors_1.JWEInvalid("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");if(t=__assign(__assign(__assign({},r),l.header),l.unprotected),checkExtensions(null==u?void 0:u.crit,r,t),void 0!==t.zip){if(!r||!r.zip)throw new errors_1.JWEInvalid('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==t.zip)throw new errors_1.JOSENotSupported('unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}if(i=t.alg,c=t.enc,"string"!=typeof i||!i)throw new errors_1.JWEInvalid("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof c||!c)throw new errors_1.JWEInvalid("missing JWE Encryption Algorithm (enc) in JWE Header");if(o=u&&checkAlgOption(u.keyManagementAlgorithms),n=u&&checkEncOption(u.contentEncryptionAlgorithms),o&&!o.has(i))throw new errors_1.JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter not allowed');if(n&&!n.has(c))throw new errors_1.JOSEAlgNotAllowed('"enc" (Encryption Algorithm) Header Parameter not allowed');return void 0!==l.encrypted_key&&(o=(0,base64url_1.decode)(l.encrypted_key),function(e){return e.reduce(function(e,r){return e+r.toString(16).padStart(2,"0")},"")}(o)),i=(0,base64url_1.decode)(l.iv),n=(0,base64url_1.decode)(l.tag),o=(0,base64url_1.decode)(l.ciphertext),a=buffer_utils_1.encoder.encode(l.protected||""),a=void 0!==l.aad?(0,buffer_utils_1.concat)(a,buffer_utils_1.encoder.encode("."),buffer_utils_1.encoder.encode(l.aad)):a,[4,(0,decrypt_1.default)(c,s,o,i,n,a)];case 1:return d=e.sent(),"DEF"!==t.zip?[3,3]:[4,((null==u?void 0:u.inflateRaw)||zlib_1.inflate)(d)];case 2:d=e.sent(),e.label=3;case 3:return c={plaintext:d},void 0!==l.protected&&(c.protectedHeader=r),void 0!==l.aad&&(c.additionalAuthenticatedData=(0,base64url_1.decode)(l.aad)),void 0!==l.unprotected&&(c.sharedUnprotectedHeader=l.unprotected),void 0!==l.header&&(c.unprotectedHeader=l.header),[2,c]}})})}exports.default=flattenedDecrypt;