"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,o,s,c){return new(s=s||Promise)(function(r,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function i(e){try{a(c.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,i)}a((c=c.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,i){var a,o,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},d={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(d[Symbol.iterator]=function(){return this}),d;function e(r){return function(e){var t=[r,e];if(a)throw new TypeError("Generator is already executing.");for(;c=d&&t[d=0]?0:c;)try{if(a=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))c.label=t[1];else if(6===t[0]&&c.label<s[1])c.label=s[1],s=t;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(t)}}t=i.call(n,c)}catch(e){t=[6,e],o=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},iv_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importDefault(require("../../lib/iv"))),base64url_1=require("../../runtime/browser/base64url"),random_1=__importDefault(require("../../runtime/browser/random")),encrypt_1=__importDefault(require("../../runtime/browser/encrypt")),zlib_1=require("../../runtime/browser/zlib"),encrypt_key_management_1=__importDefault(require("../../lib/encrypt_key_management")),errors_1=require("../../util/errors"),is_disjoint_1=__importDefault(require("../../lib/is_disjoint")),buffer_utils_1=require("../../lib/buffer_utils"),validate_crit_1=__importDefault(require("../../lib/validate_crit")),generateIv=(0,iv_1.default)(random_1.default),checkExtensions=validate_crit_1.default.bind(void 0,errors_1.JWEInvalid,new Map),FlattenedEncrypt=function(){function e(e){this._plaintext=e}return e.prototype.setKeyManagementParameters=function(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this},e.prototype.setProtectedHeader=function(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this},e.prototype.setSharedUnprotectedHeader=function(e){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this},e.prototype.setUnprotectedHeader=function(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this},e.prototype.setAdditionalAuthenticatedData=function(e){return this._aad=e,this},e.prototype.setContentEncryptionKey=function(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this},e.prototype.setInitializationVector=function(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this},e.prototype.encrypt=function(f,y){return __awaiter(this,void 0,void 0,function(){var t,r,n,i,a,o,s,c,d,_,u,l,p,h;return __generator(this,function(e){switch(e.label){case 0:if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new errors_1.JWEInvalid("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!(0,is_disjoint_1.default)(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new errors_1.JWEInvalid("JWE Shared Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");if(t=__assign(__assign(__assign({},this._protectedHeader),this._unprotectedHeader),this._sharedUnprotectedHeader),checkExtensions(null==y?void 0:y.crit,this._protectedHeader,t),void 0!==t.zip){if(!this._protectedHeader||!this._protectedHeader.zip)throw new errors_1.JWEInvalid('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==t.zip)throw new errors_1.JOSENotSupported('unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}if(l=t.alg,r=t.enc,"string"!=typeof l||!l)throw new errors_1.JWEInvalid('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof r||!r)throw new errors_1.JWEInvalid('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if("dir"===l){if(this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Encryption")}else if("ECDH-ES"===l&&this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Key Agreement");return[4,(a=void 0,encrypt_key_management_1.default)(l,r,f,this._cek,this._keyManagementParameters)];case 1:return l=e.sent(),i=l.cek,n=l.encryptedKey,(a=l.parameters)&&(this._protectedHeader?this._protectedHeader=__assign(__assign({},this._protectedHeader),a):this.setProtectedHeader(a)),this._iv||(this._iv=generateIv(r)),s=this._protectedHeader?buffer_utils_1.encoder.encode((0,base64url_1.encode)(JSON.stringify(this._protectedHeader))):buffer_utils_1.encoder.encode(""),o=this._aad?(c=(0,base64url_1.encode)(this._aad),(0,buffer_utils_1.concat)(s,buffer_utils_1.encoder.encode("."),buffer_utils_1.encoder.encode(c))):s,"DEF"!==t.zip?[3,4]:[4,((null==y?void 0:y.deflateRaw)||zlib_1.deflate)(this._plaintext)];case 2:return p=e.sent(),[4,(0,encrypt_1.default)(r,p,i,this._iv,o)];case 3:return p=e.sent(),d=p.ciphertext,_=p.tag,[3,6];case 4:return[4,(0,encrypt_1.default)(r,Buffer.from(this._plaintext),i,this._iv,o)];case 5:h=e.sent(),d=h.ciphertext,_=h.tag,e.label=6;case 6:return h={ciphertext:(0,base64url_1.encode)(d),iv:(0,base64url_1.encode)(this._iv),tag:(0,base64url_1.encode)(_)},n&&(u=function(e){return new Uint8Array(e.match(/.{1,2}/g).map(function(e){return parseInt(e,16)}))},h.encrypted_key=(0,base64url_1.encode)(u(n))),c&&(h.aad=c),this._protectedHeader&&(h.protected=buffer_utils_1.decoder.decode(s)),this._sharedUnprotectedHeader&&(h.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(h.header=this._unprotectedHeader),[2,[h,i]]}})})},e}();exports.default=FlattenedEncrypt;